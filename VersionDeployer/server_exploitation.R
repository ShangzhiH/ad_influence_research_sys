## get the original data from the data base
GetData <- eventReactive(input$Extract,{
  
  
  
  Data = GET_DATA_FROM_BBD(TableName = c('Table_Complet_Modele','Audi_Complet_Final')
                           ,AdvertiserName = 'AUDI', ModeleVehicule = input$Marque, YearBegin = input$Annee[1], YearEnd = input$Annee[2])
  
  #Data$ConfigCompleted = filter(unname(unlist(Data$ConfigCompleted)), rep(1/4, 4), method = "convolution", sides = 2)
  
  #Data$ConfigCompletednew = filter(unname(unlist(Data$ConfigCompleted)), rep(1/4, 4), method = "convolution", sides = 2)
  
  startrow = which(apply(Data, MARGIN = 1, WhichRowHasNA))
  if(length(startrow) != 0) {
    Data = Data[-startrow,]
  }
  
  
  Data_Tempo$data = Data
  
  
  
  
  #m=arimax(Data$ConfigStarted, order = c(2,0,0), xreg = as.data.frame(cbind(Data[,8],Data[,9],Data[,10],Data[,11],Data[,16],Data[,17],Data[,18],Data[,21],Data[,24],Data[,29],Data[,30])))
  return(Data)
  
})

## to see if the data is extracted correctly
output$Success <- renderText({
  if(input$Extract == 0) {
    
    return("Configure the parameters to extract the data")
    
  }
  else if(!is.null(GetData())) {
    
    return("The data has been extracted!")
    
  }
})

## if the data is not extracted, disable the button
observe({
  if (input$Extract == 0) {
    shinyjs::disable("bOK")
    shinyjs::disable("bReset")
    shinyjs::disable("MemoOK")
    shinyjs::disable("MemoReset")
    shinyjs::disable("DisplayOK")
    shinyjs::disable("DisplayReset")
    shinyjs::disable("LagOK")
    shinyjs::disable("LagReset")
    
  } else {
    shinyjs::enable("bOK")
    shinyjs::enable("bReset")
    shinyjs::enable("MemoOK")
    shinyjs::enable("MemoReset")
    shinyjs::enable("DisplayOK")
    shinyjs::enable("DisplayReset")
    shinyjs::enable("LagOK")
    shinyjs::enable("LagReset")
  }
})



## display the tranform model
output$param <- renderUI({
  
  
  
  if(!is.null(GetData())) {
    tryCatch({
      if(input$Transformation_Type %in% c("Linear")) {
        list(h5("Linear: f(x) = a0 + a1*x"),
             textInput("Param1", label = "a0", value = "0")
             ,textInput("Param2", label = "a1", value = "1"))
      }
      else if(input$Transformation_Type %in% c("Logged")) {
        
        list(h5("Logged: f(x) = a0 + a1*ln(x)"),textInput("Param1", label = "a0", value = "Enter the value")
             ,textInput("Param2", label = "a1", value = "Enter the value"))
      }
      
      else if(input$Transformation_Type %in% c("Power")) {
        list(h5("Power: f(x) = a0 + a1*x^a2"),textInput("Param1", label = "a0", value = "Enter the value")
             ,textInput("Param2", label = "a1", value = "Enter the value")
             ,textInput("Param3", label = "a2", value = "Enter the value"))
      }
      else if(input$Transformation_Type %in% c("Reciprocal")) {
        list(h5("Reciprocal: f(x) = a0 + a1/(x + a2)"),textInput("Param1", label = "a0", value = "Enter the value")
             ,textInput("Param2", label = "a1", value = "Enter the value")
             ,textInput("Param3", label = "a2", value = "Enter the value"))
      }
      else if(input$Transformation_Type %in% c("Dimishing")) {
        list(h5("Dimishing: f(x) = a0 + a1*(1-exp(-x/a2))"), textInput("Param1", label = "a0", value = "Enter the value")
             ,textInput("Param2", label = "a1", value = "Enter the value")
             ,textInput("Param3", label = "a2", value = "Enter the value"))
      }
      
      else if(input$Transformation_Type %in% c("AdBudg")) {
        list(h5("AdBudg: f(x) = a0 + a1*x^a3/(x^a3 + a2^a3)"),textInput("Param1", label = "a0", value = "Enter the value")
             ,textInput("Param2", label = "a1", value = "Enter the value")
             ,textInput("Param3", label = "a2", value = "Enter the value")
             ,textInput("Param4", label = "a3", value = "Enter the value"))
      }
    },error = function(e) {})}
  
})


## get its parameter if the model is confirmed, the transformed data is stocked in 'Data_Tempo'
IsOK <- observeEvent(input$bOK, {
  param = NULL
  tryCatch({
    param = c(param, input$Param1)
  }, error = function(e){param = c(param, NULL)})
  tryCatch({
    param = c(param, input$Param2)
  }, error = function(e){param = c(param, NULL)})
  tryCatch({
    param = c(param, input$Param3)
  }, error = function(e){param = c(param, NULL)})
  tryCatch({
    param = c(param, input$Param4)
  }, error = function(e){param = c(param, NULL)})
  
  
  
  
  x = Data_Tempo$data$date
  y = unname(unlist(Data_Tempo$data[input$Transformations]))
  
  y_t = Transform(input$Transformation_Type, y, as.numeric(param))$result
  
  #if(input$Memorisation_Type != "pas de memorisation") {
  #  y_t = Memorisation(input$Transformation_Type, y, c(0.5,0.5))
  #}
  
  Data_Tempo$data[input$Transformations] = y_t
  
  
})



## cancel the transform, the Data_Tempo is changed to be same as the original data
IsReset <- observeEvent(input$bReset, {
  
  
  DataOrigine = GetData()
  
  Data_Tempo$data[input$Transformations] = DataOrigine[input$Transformations]
  
  
})

## calculate the ADSTOCK
IsMemoOK <- observeEvent(input$MemoOK, {
  
  
  param = input$ParamMemo1
  Data = Data_Tempo$data
  
  x = Data$Date
  y = Data[input$Memorisation]
  
  y_t = Memorisation(y, as.numeric(param))
  
  
  
  Data_Tempo$data[input$Memorisation] = y_t
  
})

## cancel the ADSTOCK
IsMemoReset <- observeEvent(input$MemoReset, {
  
  Data = GetData()
  Data_Tempo$data[input$Memorisation] = Data[input$Memorisation]
  
})

## calculate the Lag
IsLagOK <- observeEvent(input$LagOK, {
  
  
  param = as.numeric(input$ParamLag)
  Data = Data_Tempo$data
  
  x = Data$Date
  y = unlist(Data[input$Lag])
  
  y_t = y
  
  y_t[1:param] = NA
  y_t[(param+1):length(y)] = y[1:(length(y)-param)]
  
  
  
  Data_Tempo$data[input$Lag] = y_t
  
  
})


## cancel the Lag
IsLagReset <- observeEvent(input$LagReset, {
  
  Data = GetData()
  Data_Tempo$data[input$Lag] = Data[input$Lag]
  
})



## display the transformed data
output$Transformation_PLOT <- renderChart2({
  tryCatch({if(input$DisplayOK == 0){
    
    return(Highcharts$new())
  }
    else{
      
      Data = GetData()
      
      x = Data$Date
      
      y = unname(unlist(Data[input$Display]))
      
      y_t = unname(unlist(Data_Tempo$data[input$Display]))
      
      
      h = Highcharts$new()
      h$chart(zoomType = 'x')
      h$title(text = input$Display)
      h$set(height=600, width=1500)
      
      
      
      h$xAxis(title = list(text = 'Date'), categories = x, labels=list(enabled = TRUE, rotation = -45))
      h$yAxis(list(list(title = list(text ="Value before transfrom")), list(title = list(text = "Value after transform"), opposite = TRUE)))
      
      
      
      
      
      h$series(yAxis = 0, name = 'Value before transform',  data = unname(y))
      h$series(yAxis = 1, name = 'Value after transform', color = '#F32525', data = unname(y_t))
      h$exporting(sourceWidth = 1500, sourceHeight = 600, scale = 15, enabled=T)
      h$tooltip(shared = TRUE)
      return(h)
    }
  },error = function(e) {return(Highcharts$new())})
})

## histo of the original data
output$hist1 <- renderChart2({
  tryCatch({if(input$DisplayOK == 0){
    
    return(Highcharts$new())
  }
    else{
      Data = GetData()
      
      x = Data$date
      
      y = unname(unlist(Data[input$Display]))
      
      
      
      
      histgramOld = Highcharts$new()
      histgramOld$chart(type = 'column')
      histgramOld$title(text = input$Display)
      histgramOld$set(height = 600, width = 1500)
      #h$set(height=400, width=1000)
      
      histgramOld$plotOptions(column = list(pointPadding=0,borderWidth=0,groupPadding=0,shadow=TRUE))
      histdata = hist(y, plot = FALSE)
      histgramOld$yAxis(list(list(title = list(text ="Counts")), list(title = list(text = "Normal distribution"), opposite = TRUE)))
      
      histgramOld$xAxis(categories = histdata$mids)
      histgramOld$series(yAxis = 0, name = 'data before transform', data = histdata$counts)
      
      
      
      histgramOld$series(yAxis=1, color = '#F32525', enableMouseTracking = FALSE, dashStyle = 'shortdot',marker = list(enabled = FALSE),type = 'spline', name = 'distribution normale', data = dnorm(histdata$mids, mean = mean(y), sd = sd(y)))
      histgramOld$exporting(sourceWidth = 1500, sourceHeight = 600, scale = 15, enabled=T)
      return(histgramOld)
    }
  },error = function(e) {return(Highcharts$new())})
  
})

## histo of the transformed data
output$hist2 <- renderChart2({
  tryCatch({if(input$DisplayOK == 0){
    
    return(Highcharts$new())
  }
    else{
      Data = GetData()
      
      x = Data$date
      
      
      
      y_t = unname(unlist(Data_Tempo$data[input$Display]))
      
      
      histgramNew = Highcharts$new()
      histgramNew$chart(type = 'column')
      histgramNew$title(text = input$Display)
      histgramNew$set(height = 600, width = 1500)
      
      histgramNew$plotOptions(column = list(pointPadding=0,borderWidth=0,groupPadding=0,shadow=TRUE))
      histdata = hist(y_t, plot = FALSE)
      
      histgramNew$yAxis(list(list(title = list(text ="Counts")), list(title = list(text = "Normal distribution"), opposite = TRUE)))
      histgramNew$xAxis(categories = histdata$mids)
      histgramNew$series(yAxis=0, name = 'data after transforme', data = histdata$counts)
      histgramNew$series(yAxis=1,color = '#F32525', enableMouseTracking = FALSE, dashStyle = 'shortdot',marker = list(enabled = FALSE),type = 'spline', name = 'distribution normale', data = dnorm(histdata$mids, mean = mean(y_t), sd = sd(y_t)))
      histgramNew$exporting(sourceWidth = 1500, sourceHeight = 600, scale = 15, enabled=T)
      return(histgramNew)
    }
  },error = function(e) {return(Highcharts$new())})
  
})



## if we want some more treatement(not availale yet)
observeEvent(input$FunctionOK, {
  data = Data_Tempo$data
  
})